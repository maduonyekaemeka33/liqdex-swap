<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jupiter Swap ‚Äì Direct Execution</title>

<!-- Phantom Wallet & Solana adapters -->
<script src="https://unpkg.com/@solana/wallet-adapter-base@latest/dist/index.umd.js"></script>
<script src="https://unpkg.com/@solana/wallet-adapter-wallets@latest/dist/index.umd.js"></script>
<script src="https://unpkg.com/@solana/wallet-adapter-phantom@latest/dist/index.umd.js"></script>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

<style>
body { font-family: Arial; background:#f9f9f9; padding:20px; }
button { padding:10px 16px; margin:5px; cursor:pointer; border:none; border-radius:6px; font-weight:bold; }
input, select { padding:8px; margin:5px 0; width:300px; }
#quoteResult { background:#eee; padding:10px; border-radius:6px; margin-top:10px; white-space:pre-wrap; }
#terms { background:#fff3cd; padding:12px; border-radius:8px; margin-top:20px; font-size:14px; }
</style>
</head>
<body>

<h1>Jupiter Swap ‚Äì Direct Execution</h1>

<!-- Wallet connect -->
<button id="connectWalletBtn">Connect Phantom Wallet</button>
<p id="walletAddress"></p>

<!-- Wallet permission modal -->
<div id="permissionModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:999;">
  <div style="background:#fff; max-width:400px; margin:80px auto; padding:20px; border-radius:10px;">
    <h3>üîê Wallet Permissions</h3>
    <p>By connecting your wallet, this website can:
      <ul>
        <li>View your public wallet address</li>
        <li>View token balances</li>
      </ul>
      We <strong>cannot</strong> move funds without your explicit approval.
    </p>
    <button onclick="confirmWalletConnect()" style="background:#4caf50; color:#fff;">Continue</button>
  </div>
</div>

<!-- Swap form -->
<h3>Swap Tokens</h3>
<label>From Token</label>
<select id="fromToken">
  <option value="So11111111111111111111111111111111111111112">SOL</option>
  <option value="Es9vMFrzaCERmJfrF4H2FYD4zY2S7hF7YJ8i3S3NwY">USDT</option>
  <option value="EPjFWdd5AufqSSqeM2q9A9W4r1hJ8g9Gz8k3g9x">USDC</option>
</select>

<label>To Token</label>
<select id="toToken">
  <option value="EPjFWdd5AufqSSqeM2q9A9W4r1hJ8g9Gz8k3g9x">USDC</option>
  <option value="Es9vMFrzaCERmJfrF4H2FYD4zY2S7hF7YJ8i3S3NwY">USDT</option>
  <option value="So11111111111111111111111111111111111111112">SOL</option>
</select>

<label>Amount (in lamports, 1 SOL = 1_000_000_000)</label>
<input type="number" id="amount">

<label>Slippage (%)</label>
<input type="number" id="slippage" value="1" min="0.1" step="0.1">

<label><input type="checkbox" id="devnetToggle"> Use Devnet (testing)</label><br>

<button id="getQuoteBtn">Get Quote</button>
<div id="quoteResult"></div>
<button id="swapBtn" style="background:#4caf50; color:white; display:none;">Execute Swap</button>

<div id="terms">
<strong>‚ö†Ô∏è Risk Disclaimer</strong><br><br>
This website is a non-custodial interface. All transactions require your wallet approval.
Cryptocurrency trading involves risk. Use at your own discretion.
</div>

<script>
let provider;
let walletAddress;
let currentRoute;

// Wallet modal
document.getElementById("connectWalletBtn").onclick = () => {
  document.getElementById("permissionModal").style.display = "block";
};

async function confirmWalletConnect() {
  document.getElementById("permissionModal").style.display = "none";
  if (!window.solana?.isPhantom) {
    alert("Phantom Wallet not found");
    return;
  }
  provider = window.solana;
  const resp = await provider.connect();
  walletAddress = resp.publicKey.toString();
  document.getElementById("walletAddress").innerText = "Connected: " + walletAddress;
}

// Helper to get cluster
function getCluster() {
  return document.getElementById("devnetToggle").checked ? "devnet" : "mainnet-beta";
}

// Get quote from serverless API
document.getElementById("getQuoteBtn").onclick = async () => {
  const fromToken = document.getElementById("fromToken").value;
  const toToken = document.getElementById("toToken").value;
  const amount = document.getElementById("amount").value;
  const slippage = document.getElementById("slippage").value;

  if (!fromToken || !toToken || !amount) { alert("Enter all fields"); return; }

  try {
    const resp = await fetch(`/api/quote?fromToken=${fromToken}&toToken=${toToken}&amount=${amount}&slippage=${slippage}&cluster=${getCluster()}`);
    const data = await resp.json();
    if (!data.routes || data.routes.length === 0) {
      document.getElementById("quoteResult").innerText = "No swap routes found.";
      document.getElementById("swapBtn").style.display = "none";
      return;
    }
    currentRoute = data.routes[0];
    document.getElementById("quoteResult").innerText = JSON.stringify(currentRoute, null, 2);
    document.getElementById("swapBtn").style.display = "inline-block";
  } catch (err) {
    document.getElementById("quoteResult").innerText = "Error fetching quote: " + err.message;
  }
};

// Execute swap
document.getElementById("swapBtn").onclick = async () => {
  if (!provider || !walletAddress || !currentRoute) { alert("Connect wallet and get quote first"); return; }

  try {
    const response = await fetch("/api/swap", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ route: currentRoute, userPublicKey: walletAddress })
    });

    const { swapTransaction } = await response.json();
    const txBuffer = Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0));
    const transaction = solanaWeb3.VersionedTransaction.deserialize(txBuffer);
    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl(getCluster()), "confirmed");
    const signedTx = await provider.signTransaction(transaction);
    const txid = await connection.sendRawTransaction(signedTx.serialize());
    await connection.confirmTransaction(txid);

    alert("‚úÖ Swap successful! TXID:\n" + txid);
  } catch (err) {
    alert("‚ùå Swap failed: " + err.message);
  }
};
</script>
</body>
  </html>
